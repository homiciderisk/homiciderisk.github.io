<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Migration Risk Explorer (Single File)</title>
<style>
  :root { --bg:#fff; --fg:#111; --muted:#6b7280; --panel:#f8f9fb; --line:#e5e7eb; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--fg); background:var(--bg); line-height:1.5; }
  .container { max-width:980px; margin:20px auto; padding:0 16px; }
  header h1 { font-size: clamp(18px, 2.0vw, 28px); font-weight:700; margin:0 0 6px; }
  header p.sub { color:var(--muted); margin:6px 0 0; font-size:15px; }
  .panel { background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:14px; overflow:hidden; }
  .selectors { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
  select { width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px; font-size:15px; background:#fff; }
  .summary { margin-top:12px; font-size:18px; font-weight:600; }
  .context-line { margin-top:6px; font-size:14px; color:var(--muted); }
  .viz { margin-top:14px; }
  .chart-wrap { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px 14px; }
  .chart-title { font-size:16px; font-weight:600; margin-bottom:10px; }
  .chart { width:100%; height:180px; }
  .legend { display:flex; gap:12px; align-items:center; margin-top:8px; font-size:13px; color:#6b7280; }
  .swatch { width:12px; height:12px; border-radius:3px; display:inline-block; }
  .base { background:#9ca3af; } .pred { background:#374151; }
  .map-card { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; position:relative; overflow:hidden; }
  .map-card img { display:block; max-width:100%; height:auto; border-radius:6px; }
  .map-overlay { position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }
  .caption { font-size:12px; color:#6b7280; margin-top:6px; }
  input[type=range] { width:100%; }
  .slider-labels { display:flex; justify-content:space-between; font-size:12px; color:#6b7280; margin-top:6px; }
  .slider-output { margin-top:8px; font-size:16px; font-weight:600; }
  .notes p { margin:0 0 8px; }
  .notes code { background:#fff; padding:0 4px; border:1px solid var(--line); border-radius:4px; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Your risk of homicide depends on where you live — and where you’re from.</h1>
      <p class="sub">Pick your current state and your birth state. We’ll show how origin changes risk compared to locals where you live.</p>
    </header>

    <section class="panel">
      <div class="selectors">
        <div>
          <label>Current state (residence)</label>
          <select id="select-res"><option value="" selected disabled>Choose…</option></select>
        </div>
        <div>
          <label>Birth state (origin)</label>
          <select id="select-birth"><option value="" selected disabled>Choose…</option></select>
        </div>
      </div>

      <div id="summary" class="summary" aria-live="polite">Pick a residence to start.</div>
      <div id="context" class="context-line"></div>

      <div class="viz">
        <div class="chart-wrap">
          <div class="chart-title">Homicide risk (per 100,000)</div>
          <svg class="chart" viewBox="0 0 680 180" role="img" aria-label="Homicide rates bar chart">
            <defs><clipPath id="barsClip"><rect x="140" y="10" width="520" height="160" rx="4"/></clipPath></defs>
            <g id="ylabels" font-size="13" fill="#374151" font-family="inherit">
              <text x="10" y="65">Locals in <tspan id="lbl-res">—</tspan></text>
              <text x="10" y="130">People from <tspan id="lbl-birth">—</tspan> living here</text>
            </g>
            <g clip-path="url(#barsClip)">
              <rect id="bar-base" x="140" y="50" width="0" height="24" fill="#9ca3af" rx="4"></rect>
              <rect id="bar-pred" x="140" y="115" width="0" height="24" fill="#374151" rx="4"></rect>
            </g>
            <g id="val-labels" font-size="12" fill="#111827">
              <text id="val-base" x="145" y="45">—</text>
              <text id="val-pred" x="145" y="110">—</text>
            </g>
          </svg>
          <div class="legend"><span class="swatch base"></span> Locals <span class="swatch pred"></span> With birth-state adjustment</div>
        </div>
      </div>
    </section>

    <section class="panel" style="margin-top:16px;">
      <div class="map-card">
        <!-- Embedded Base64 PNG; this is the real map image -->
        <img id="us-map-img" src="data:image/png;base64,<!--BASE64_BYTES_INSERTED_IN_DOWNLOAD-->" alt="Historical homicide rates map (1933–42 whites)" />
        <svg id="map-overlay" class="map-overlay" aria-label="Map overlay with spikes"></svg>
        <div class="caption">Historical homicide rates (1933–42, whites). <strong>Brighter = more violent origins.</strong> Hover spikes for details.</div>
      </div>
    </section>

    <section class="panel" style="margin-top:16px;">
      <label style="font-size:14px;font-weight:600;">Try it: slide from the safest to the most violent origin</label>
      <input id="origin-slider" type="range" min="0" max="100" value="0" />
      <div class="slider-labels"><span>Safest</span><span>Most violent</span></div>
      <div id="slider-out" class="slider-output">Pick a residence to see the range.</div>
    </section>

    <section class="panel notes" style="margin-top:16px;">
      <p><strong>How we estimated these numbers</strong></p>
      <p>We start with the homicide rate for locals in your residence state. Then we adjust it using how violent your birth state was in the 1930s. The adjustment uses <code>β = 0.23</code>, <code>G = 4.0149</code>, and a calibration <code>k = 1.0179</code> so totals match what we see in the data.</p>
      <p>These estimates are for <strong>white, non-Hispanic Americans</strong>, using 2000–2017 outcomes and 1933–1942 historical inputs. There isn’t enough data here to do the same for other racial groups. DC is included.</p>
    </section>
  </div>

<script>
/* Fixed-effects calibrated constants */
const DATA = {"beta_m":0.23,"G_hist_geomean_migrants":4.0149,"calibration_k":1.0179,"states":[
  /* state, local baseline (non-migrants), 1930s birth-state rate (whites) */
  {"state":"AL","baseline_rate":/* … */,"hist_rate_1933_42":8.01872},
  {"state":"AZ","baseline_rate":/* … */,"hist_rate_1933_42":9.10502},
  {"state":"AR","baseline_rate":/* … */,"hist_rate_1933_42":6.15651},
  {"state":"CA","baseline_rate":/* … */,"hist_rate_1933_42":4.55357},
  {"state":"CO","baseline_rate":/* … */,"hist_rate_1933_42":5.23045},
  {"state":"CT","baseline_rate":/* … */,"hist_rate_1933_42":1.94104},
  {"state":"DE","baseline_rate":/* … */,"hist_rate_1933_42":6.78969},
  {"state":"DC","baseline_rate":/* … */,"hist_rate_1933_42":4.87126},
  {"state":"FL","baseline_rate":/* … */,"hist_rate_1933_42":8.11652},
  {"state":"GA","baseline_rate":/* … */,"hist_rate_1933_42":7.2337},
  {"state":"ID","baseline_rate":/* … */,"hist_rate_1933_42":3.69821},
  {"state":"IL","baseline_rate":/* … */,"hist_rate_1933_42":5.43732},
  {"state":"IN","baseline_rate":/* … */,"hist_rate_1933_42":3.81921},
  {"state":"IA","baseline_rate":/* … */,"hist_rate_1933_42":1.73964},
  {"state":"KS","baseline_rate":/* … */,"hist_rate_1933_42":3.55055},
  {"state":"KY","baseline_rate":/* … */,"hist_rate_1933_42":12.0996},
  {"state":"LA","baseline_rate":/* … */,"hist_rate_1933_42":6.37093},
  {"state":"ME","baseline_rate":/* … */,"hist_rate_1933_42":1.62282},
  {"state":"MD","baseline_rate":/* … */,"hist_rate_1933_42":2.69168},
  {"state":"MA","baseline_rate":/* … */,"hist_rate_1933_42":1.64486},
  {"state":"MI","baseline_rate":/* … */,"hist_rate_1933_42":3.04919},
  {"state":"MN","baseline_rate":/* … */,"hist_rate_1933_42":1.96978},
  {"state":"MS","baseline_rate":/* … */,"hist_rate_1933_42":7.79703},
  {"state":"MO","baseline_rate":/* … */,"hist_rate_1933_42":6.70437},
  {"state":"MT","baseline_rate":/* … */,"hist_rate_1933_42":4.72656},
  {"state":"NE","baseline_rate":/* … */,"hist_rate_1933_42":2.15882},
  {"state":"NV","baseline_rate":/* … */,"hist_rate_1933_42":10.9211},
  {"state":"NH","baseline_rate":/* … */,"hist_rate_1933_42":1.42662},
  {"state":"NJ","baseline_rate":/* … */,"hist_rate_1933_42":2.82033},
  {"state":"NM","baseline_rate":/* … */,"hist_rate_1933_42":7.89517},
  {"state":"NY","baseline_rate":/* … */,"hist_rate_1933_42":3.2948},
  {"state":"NC","baseline_rate":/* … */,"hist_rate_1933_42":4.81721},
  {"state":"ND","baseline_rate":/* … */,"hist_rate_1933_42":1.70562},
  {"state":"OH","baseline_rate":/* … */,"hist_rate_1933_42":4.66822},
  {"state":"OK","baseline_rate":/* … */,"hist_rate_1933_42":5.40989},
  {"state":"OR","baseline_rate":/* … */,"hist_rate_1933_42":3.16651},
  {"state":"PA","baseline_rate":/* … */,"hist_rate_1933_42":2.79196},
  {"state":"RI","baseline_rate":/* … */,"hist_rate_1933_42":1.45662},
  {"state":"SC","baseline_rate":/* … */,"hist_rate_1933_42":7.22708},
  {"state":"SD","baseline_rate":/* … */,"hist_rate_1933_42":1.48273},
  {"state":"TN","baseline_rate":/* … */,"hist_rate_1933_42":8.17937},
  {"state":"TX","baseline_rate":/* … */,"hist_rate_1933_42":7.05155},
  {"state":"UT","baseline_rate":/* … */,"hist_rate_1933_42":2.8711},
  {"state":"VA","baseline_rate":/* … */,"hist_rate_1933_42":5.87689},
  {"state":"VT","baseline_rate":/* … */,"hist_rate_1933_42":1.37595},
  {"state":"WA","baseline_rate":/* … */,"hist_rate_1933_42":3.6758},
  {"state":"WV","baseline_rate":/* … */,"hist_rate_1933_42":8.16957},
  {"state":"WI","baseline_rate":/* … */,"hist_rate_1933_42":1.57173},
  {"state":"WY","baseline_rate":/* … */,"hist_rate_1933_42":4.8803}
]};

const selectRes = document.getElementById('select-res');
const selectBirth = document.getElementById('select-birth');
const lblRes = document.getElementById('lbl-res');
const lblBirth = document.getElementById('lbl-birth');
const summary = document.getElementById('summary');
const context = document.getElementById('context');
const barBase = document.getElementById('bar-base');
const barPred = document.getElementById('bar-pred');
const valBase = document.getElementById('val-base');
const valPred = document.getElementById('val-pred');
const originSlider = document.getElementById('origin-slider');
const sliderOut = document.getElementById('slider-out');
const mapImg = document.getElementById('us-map-img');
const svg = document.getElementById('map-overlay');

const byState = new Map(DATA.states.map(s => [s.state, s]));
const codes = DATA.states.map(s => s.state).sort();

for (const code of codes) {
  for (const sel of [selectRes, selectBirth]) {
    const opt = document.createElement('option');
    opt.value = code; opt.textContent = code;
    sel.appendChild(opt);
  }
}

const x0 = 140, xMax = 660;
const fullWidth = xMax - x0;

function fmt(n) { return (n ?? 0).toFixed(2); }
function pctDelta(from, to) { if (!from || !isFinite(from)) return 0; return ((to - from)/from)*100; }

function messageForHist(stateCode) {
  const s = byState.get(stateCode);
  if (!s) return '';
  const histVals = DATA.states.map(s => s.hist_rate_1933_42).slice().sort((a,b)=>a-b);
  const T1 = histVals[Math.floor(histVals.length/3)];
  const T2 = histVals[Math.floor(2*histVals.length/3)];
  const h = s.hist_rate_1933_42;
  if (h <= T1) return 'In the 1930s, ' + stateCode + ' was one of the safer states. That history still shows up today.';
  if (h >= T2) return 'In the 1930s, ' + stateCode + ' was among the most violent. That history still shows up today.';
  return 'In the 1930s, ' + stateCode + ' was about average. That history still shows up today.';
}

function mkScale(maxVal) {
  const domainMax = Math.max(1, maxVal) * 1.10;
  return v => x0 + Math.max(0, Math.min(v, domainMax)) / domainMax * fullWidth;
}

function renderBaseline(res) {
  const r = byState.get(res);
  lblRes.textContent = res || '—';
  if (!r) return;
  const baseline = r.baseline_rate;
  const scaleX = mkScale(baseline);
  const baseWidth = scaleX(baseline) - x0;
  barBase.style.transition = 'width 250ms ease';
  barBase.setAttribute('width', baseWidth);
  valBase.setAttribute('x', x0 + baseWidth + 6);
  valBase.textContent = fmt(baseline);
  summary.innerHTML = 'Locals in <strong>' + res + '</strong> are at <strong>' + fmt(baseline) + '</strong> per 100,000.';
}

function predictFrom(res, birth) {
  const r = byState.get(res), b = byState.get(birth);
  if (!r || !b) return null;
  const baseline = r.baseline_rate;
  const G = DATA.G_hist_geomean_migrants, beta = DATA.beta_m, k = DATA.calibration_k;
  const factor = k * Math.pow(b.hist_rate_1933_42 / G, beta);
  return baseline * factor;
}

function update() {
  const res = selectRes.value;
  const birth = selectBirth.value;
  const r = byState.get(res);
  const b = byState.get(birth);

  if (!r) {
    barBase.setAttribute('width','0'); barPred.setAttribute('width','0');
    valBase.textContent = '—'; valPred.textContent = '—';
    lblRes.textContent = '—'; lblBirth.textContent = '—';
    summary.textContent = 'Pick a residence to start.';
    context.textContent = '';
    sliderOut.textContent = 'Pick a residence to see the range.';
    return;
  }

  renderBaseline(res);

  if (!b) {
    lblBirth.textContent = '—';
    barPred.setAttribute('width','0'); valPred.textContent = '—';
    context.textContent = '';
    return;
  }

  lblBirth.textContent = birth;
  const baseline = r.baseline_rate;
  const predicted = predictFrom(res, birth);
  const scaleX = mkScale(Math.max(baseline, predicted));
  const predWidth = scaleX(predicted) - x0;
  const baseWidth = scaleX(baseline) - x0;

  barBase.style.transition = 'width 250ms ease'; barPred.style.transition = 'width 250ms ease';
  barBase.setAttribute('width', baseWidth);
  barPred.setAttribute('width', predWidth);
  valBase.setAttribute('x', x0 + baseWidth + 6); valBase.textContent = fmt(baseline);
  valPred.setAttribute('x', x0 + predWidth + 6); valPred.textContent = fmt(predicted);

  const pct = pctDelta(baseline, predicted);
  const moreLess = pct >= 0 ? 'higher' : 'lower';
  summary.innerHTML = 'People from <strong>' + birth + '</strong> living in <strong>' + res + '</strong> are about <strong>' + Math.abs(pct).toFixed(1) + '%</strong> ' + moreLess + ' than locals (' + fmt(predicted) + ' vs ' + fmt(baseline) + ' per 100k).';

  context.textContent = messageForHist(birth);
}

/* Map spikes overlay with native tooltips */
const CENTROIDS = {
"AL":[32.806671,-86.791130],"AR":[34.969704,-92.373123],"AZ":[33.729759,-111.431221],"CA":[36.116203,-119.681564],
"CO":[39.059811,-105.311104],"CT":[41.597782,-72.755371],"DC":[38.897438,-77.026817],"DE":[39.318523,-75.507141],
"FL":[27.766279,-81.686783],"GA":[33.040619,-83.643074],"IA":[42.011539,-93.210526],"ID":[44.240459,-114.478828],
"IL":[40.349457,-88.986137],"IN":[39.849426,-86.258278],"KS":[38.526600,-96.726486],"KY":[37.668140,-84.670067],
"LA":[31.169546,-91.867805],"MA":[42.230171,-71.530106],"MD":[39.063946,-76.802101],"ME":[44.693947,-69.381927],
"MI":[43.326618,-84.536095],"MN":[45.694454,-93.900192],"MO":[38.456085,-92.288368],"MS":[32.741646,-89.678696],
"MT":[46.921925,-110.454353],"NC":[35.630066,-79.806419],"ND":[47.528912,-99.784012],"NE":[41.125370,-98.268082],
"NH":[43.452492,-71.563896],"NJ":[40.298904,-74.521011],"NM":[34.840515,-106.248482],"NV":[38.313515,-117.055374],
"NY":[42.165726,-74.948051],"OH":[40.388783,-82.764915],"OK":[35.565342,-96.928917],"OR":[44.572021,-122.070938],
"PA":[40.590752,-77.209755],"RI":[41.680893,-71.511780],"SC":[33.856892,-80.945007],"SD":[44.299782,-99.438828],
"TN":[35.747845,-86.692345],"TX":[31.054487,-97.563461],"UT":[40.150032,-111.862434],"VA":[37.769337,-78.169968],
"VT":[44.045876,-72.710686],"WA":[47.400902,-121.490494],"WI":[44.268543,-89.616508],"WV":[38.491226,-80.954453],
"WY":[42.755966,-107.302490]
};

function projectLonLatToImageXY(lon, lat, img) {
  const minLon = -125, maxLon = -66;
  const minLat = 24, maxLat = 50;
  const pad = 20;
  const w = img.clientWidth, h = img.clientHeight;
  const x = pad + ((lon - minLon) / (maxLon - minLon)) * (w - 2*pad);
  const y = pad + (1 - (lat - minLat) / (maxLat - minLat)) * (h - 2*pad);
  return [x, y];
}

function colorForHist(v) {
  const vals = DATA.states.map(s => s.hist_rate_1933_42);
  const minV = Math.min(...vals), maxV = Math.max(...vals);
  const t = (v - minV) / (maxV - minV + 1e-9);
  let h, s = 80, l = 50;
  if (t < 0.5) { h = 270 + (320 - 270) * (t/0.5); }
  else { h = 320 + (420 - 320) * ((t-0.5)/0.5); }
  h = h % 360;
  return `hsl(${h.toFixed(0)}, ${s}%, ${l}%)`;
}

function drawSpikes() {
  if (!mapImg || !svg) return;
  const w = mapImg.clientWidth, h = mapImg.clientHeight;
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  svg.setAttribute('preserveAspectRatio','xMidYMid meet');
  svg.innerHTML = '';

  const vals = DATA.states.map(s => s.hist_rate_1933_42);
  const minV = Math.min(...vals), maxV = Math.max(...vals);
  const maxSpike = Math.max(16, Math.min(60, h * 0.18));

  for (const s of DATA.states) {
    const st = s.state;
    if (!CENTROIDS[st]) continue;
    const [lat, lon] = CENTROIDS[st];
    const [x, y] = projectLonLatToImageXY(lon, lat, mapImg);
    const t = (s.hist_rate_1933_42 - minV) / (maxV - minV + 1e-9);
    const height = 6 + t * maxSpike;
    const base = 10;
    const color = colorForHist(s.hist_rate_1933_42);
    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
    const d = `M ${x-base/2} ${y} L ${x+base/2} ${y} L ${x} ${y-height} Z`;
    path.setAttribute('d', d);
    path.setAttribute('fill', color);
    path.setAttribute('stroke', 'rgba(0,0,0,0.25)');
    path.setAttribute('stroke-width', '0.5');
    const title = document.createElementNS('http://www.w3.org/2000/svg','title');
    title.textContent = `${st} — 1933–42 rate: ${s.hist_rate_1933_42.toFixed(2)} per 100k`;
    path.appendChild(title);
    svg.appendChild(path);
  }
}

window.addEventListener('load', drawSpikes);
window.addEventListener('resize', drawSpikes);

// Slider logic
const minHist = Math.min(...DATA.states.map(s => s.hist_rate_1933_42));
const maxHist = Math.max(...DATA.states.map(s => s.hist_rate_1933_42));

originSlider.addEventListener('input', () => {
  const res = selectRes.value;
  if (!res) { sliderOut.textContent = 'Pick a residence to see the range.'; return; }
  const r = byState.get(res);
  const baseline = r.baseline_rate;
  const t = originSlider.value / 100;
  const h = minHist + t*(maxHist - minHist);
  const G = DATA.G_hist_geomean_migrants, beta = DATA.beta_m, k = DATA.calibration_k;
  const low = baseline * (k * Math.pow(minHist/G, beta));
  const high = baseline * (k * Math.pow(maxHist/G, beta));
  const predicted = baseline * (k * Math.pow(h/G, beta));
  const pct = pctDelta(baseline, predicted);
  const moreLess = pct >= 0 ? 'higher' : 'lower';
  sliderOut.textContent = 'Range: ' + fmt(low) + ' to ' + fmt(high) + ' per 100k — current slider is ' + fmt(predicted) + ' (' + Math.abs(pct).toFixed(1) + '% ' + moreLess + ' than locals).';
});

selectRes.addEventListener('change', update);
selectBirth.addEventListener('change', update);
</script>
</body>
</html>
