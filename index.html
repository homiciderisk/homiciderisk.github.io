<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Migration Risk Explorer</title>
<style>
  :root { --bg:#fff; --fg:#111; --muted:#6b7280; --panel:#f8f9fb; --line:#e5e7eb; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--fg); background:var(--bg); line-height:1.5; }
  .container { max-width:980px; margin:20px auto; padding:0 16px; }
  header h1 { font-size: clamp(18px, 2.0vw, 28px); font-weight:700; margin:0 0 6px; }
  header p.sub { color:var(--muted); margin:6px 0 0; font-size:15px; }
  .panel { background:var(--panel); border:1px solid var(--line); border-radius:10px; padding:14px; overflow:hidden; }
  .selectors { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
  select { width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px; font-size:15px; background:#fff; }
  .summary { margin-top:12px; font-size:19px; font-weight:600; }
  .context-line { margin-top:6px; font-size:14px; color:var(--muted); }
  .viz { margin-top:14px; }
  .chart-wrap { background:#fff; border:1px solid var(--line); border-radius:10px; padding:12px 14px; }
  .chart-title { font-size:17px; font-weight:600; margin-bottom:10px; }
  .chart { width:100%; height:180px; }
  .legend { display:flex; gap:12px; align-items:center; margin-top:8px; font-size:13px; color:var(--muted); }
  .swatch { width:12px; height:12px; border-radius:3px; display:inline-block; }
  .base { background:#9ca3af; } .pred { background:#374151; }
  /* Slider */
  input[type=range] { width:100%; }
  .slider-labels { display:flex; justify-content:space-between; font-size:12px; color:#6b7280; margin-top:6px; }
  .slider-output { margin-top:8px; font-size:16px; font-weight:600; }
  /* Map panel */ 
  .map-card { background:#fff; border:1px solid var(--line); border-radius:10px; padding:10px; }
  .map-card img { display:block; max-width:100%; height:auto; border-radius:6px; }
  .caption { font-size:12px; color:#6b7280; margin-top:6px; }
  /* Notes panel */
  .notes p { margin: 0 0 8px; }
  .notes code { background:#fff; padding:0 4px; border:1px solid var(--line); border-radius:4px; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Your risk of homicide depends not only on where you live—but also where you come from.</h1>
      <p class="sub">Pick your current state and birth state to see how origin shifts risk relative to locals in your state of residence.</p>
    </header>

    <!-- Interactive panel -->
    <section class="panel">
      <div class="selectors">
        <div>
          <label>Current state (residence)</label>
          <select id="select-res"><option value="" selected disabled>Choose…</option></select>
        </div>
        <div>
          <label>Birth state (origin)</label>
          <select id="select-birth"><option value="" selected disabled>Choose…</option></select>
        </div>
      </div>

      <div id="summary" class="summary" aria-live="polite">Pick your states to view your estimated risk.</div>
      <div id="context" class="context-line"></div>

      <div class="viz">
        <div class="chart-wrap">
          <div class="chart-title">Homicide risk (per 100,000)</div>
          <svg class="chart" viewBox="0 0 680 180" role="img" aria-label="Homicide rates bar chart">
            <defs><clipPath id="barsClip"><rect x="140" y="10" width="520" height="160" rx="4"/></clipPath></defs>
            <g id="ylabels" font-size="13" fill="#374151" font-family="inherit">
              <text x="10" y="65">Locals in <tspan id="lbl-res">—</tspan></text>
              <text x="10" y="130">Migrants from <tspan id="lbl-birth">—</tspan></text>
            </g>
            <g clip-path="url(#barsClip)">
              <rect id="bar-base" x="140" y="50" width="0" height="24" fill="#9ca3af" rx="4"></rect>
              <rect id="bar-pred" x="140" y="115" width="0" height="24" fill="#374151" rx="4"></rect>
            </g>
            <g id="val-labels" font-size="12" fill="#111827">
              <text id="val-base" x="145" y="45">—</text>
              <text id="val-pred" x="145" y="110">—</text>
            </g>
          </svg>
          <div class="legend"><span class="swatch base"></span> Locals baseline <span class="swatch pred"></span> Adjusted with origin</div>
        </div>
      </div>
    </section>

    <!-- Map panel (separate) -->

    <section class="panel" style="margin-top:16px; display:flex; justify-content:center;">
  <div class="map-card" style="display:flex; justify-content:center; align-items:center;">
    <img src="data:image/png;base64,..." style="max-width:100%; height:auto; display:block;" />
  </div>
</section>


    <!-- Slider panel (separate) -->
    <section class="panel" style="margin-top:16px;">
      <label style="font-size:14px;font-weight:600;">Try it: What if your birth state ranged from safest to most violent?</label>
      <input id="origin-slider" type="range" min="0" max="100" value="0" />
      <div class="slider-labels"><span>Safest</span><span>Most violent</span></div>
      <div id="slider-out" class="slider-output">Choose a residence first to see the effect.</div>
    </section>

    <!-- Technical notes panel (bottom-most) -->
    <section class="panel notes" style="margin-top:16px;">
      <p><strong>Technical notes</strong></p>
      <p>Estimates for <strong>white, non‑Hispanic Americans</strong>. Outcomes are 2000–2017 homicide rates; historical inputs are 1933–1942 white homicide rates. There is insufficient data to provide stable estimates for non‑white populations in this framework. DC is included.</p>
      <p>Method: We anchor on the non‑migrant homicide rate for your residence state and adjust by a calibrated factor <code>k × (Hist_birth / G)^β</code> with β = 0.23, G = 4.01, k = 1.018. Intercepts are re‑anchored so totals match observed migrant deaths under the actual origin mix.</p>
    </section>
  </div>

<script>
const DATA = {"states": [{"state": "AL", "baseline_rate": 6.1781, "hist_rate_1933_42": 8.0187}, {"state": "AR", "baseline_rate": 5.8271, "hist_rate_1933_42": 6.1565}, {"state": "AZ", "baseline_rate": 6.656, "hist_rate_1933_42": 9.105}, {"state": "CA", "baseline_rate": 4.2195, "hist_rate_1933_42": 4.5536}, {"state": "CO", "baseline_rate": 3.1493, "hist_rate_1933_42": 5.2304}, {"state": "CT", "baseline_rate": 1.5974, "hist_rate_1933_42": 1.941}, {"state": "DC", "baseline_rate": 7.0975, "hist_rate_1933_42": 4.8713}, {"state": "DE", "baseline_rate": 2.9374, "hist_rate_1933_42": 6.7897}, {"state": "FL", "baseline_rate": 5.2767, "hist_rate_1933_42": 8.1165}, {"state": "GA", "baseline_rate": 4.0834, "hist_rate_1933_42": 7.2337}, {"state": "IA", "baseline_rate": 1.6456, "hist_rate_1933_42": 1.7396}, {"state": "ID", "baseline_rate": 1.9905, "hist_rate_1933_42": 3.6982}, {"state": "IL", "baseline_rate": 2.2991, "hist_rate_1933_42": 5.4373}, {"state": "IN", "baseline_rate": 3.3464, "hist_rate_1933_42": 3.8192}, {"state": "KS", "baseline_rate": 2.8764, "hist_rate_1933_42": 3.5505}, {"state": "KY", "baseline_rate": 4.8305, "hist_rate_1933_42": 12.0996}, {"state": "LA", "baseline_rate": 5.5564, "hist_rate_1933_42": 6.3709}, {"state": "MA", "baseline_rate": 1.5344, "hist_rate_1933_42": 1.6449}, {"state": "MD", "baseline_rate": 3.2234, "hist_rate_1933_42": 2.6917}, {"state": "ME", "baseline_rate": 2.0843, "hist_rate_1933_42": 1.6228}, {"state": "MI", "baseline_rate": 2.4394, "hist_rate_1933_42": 3.0492}, {"state": "MN", "baseline_rate": 1.4488, "hist_rate_1933_42": 1.9698}, {"state": "MO", "baseline_rate": 3.9698, "hist_rate_1933_42": 6.7044}, {"state": "MS", "baseline_rate": 5.989, "hist_rate_1933_42": 7.797}, {"state": "MT", "baseline_rate": 2.5032, "hist_rate_1933_42": 4.7266}, {"state": "NC", "baseline_rate": 5.0809, "hist_rate_1933_42": 4.8172}, {"state": "ND", "baseline_rate": 1.0427, "hist_rate_1933_42": 1.7056}, {"state": "NE", "baseline_rate": 1.9497, "hist_rate_1933_42": 2.1588}, {"state": "NH", "baseline_rate": 1.8655, "hist_rate_1933_42": 1.4266}, {"state": "NJ", "baseline_rate": 1.4309, "hist_rate_1933_42": 2.8203}, {"state": "NM", "baseline_rate": 7.0791, "hist_rate_1933_42": 7.8952}, {"state": "NV", "baseline_rate": 6.2754, "hist_rate_1933_42": 10.9211}, {"state": "NY", "baseline_rate": 2.9629, "hist_rate_1933_42": 3.2948}, {"state": "OH", "baseline_rate": 3.0822, "hist_rate_1933_42": 4.6682}, {"state": "OK", "baseline_rate": 6.5132, "hist_rate_1933_42": 5.4099}, {"state": "OR", "baseline_rate": 3.2356, "hist_rate_1933_42": 3.1665}, {"state": "PA", "baseline_rate": 2.4532, "hist_rate_1933_42": 2.792}, {"state": "RI", "baseline_rate": 2.1672, "hist_rate_1933_42": 1.4566}, {"state": "SC", "baseline_rate": 6.1011, "hist_rate_1933_42": 7.2271}, {"state": "SD", "baseline_rate": 1.0841, "hist_rate_1933_42": 1.4827}, {"state": "TN", "baseline_rate": 5.3739, "hist_rate_1933_42": 8.1794}, {"state": "TX", "baseline_rate": 5.1729, "hist_rate_1933_42": 7.0515}, {"state": "UT", "baseline_rate": 1.6657, "hist_rate_1933_42": 2.8711}, {"state": "VA", "baseline_rate": 3.5597, "hist_rate_1933_42": 5.8769}, {"state": "VT", "baseline_rate": 2.1618, "hist_rate_1933_42": 1.376}, {"state": "WA", "baseline_rate": 3.239, "hist_rate_1933_42": 3.6758}, {"state": "WI", "baseline_rate": 1.689, "hist_rate_1933_42": 1.5717}, {"state": "WV", "baseline_rate": 5.3788, "hist_rate_1933_42": 8.1696}, {"state": "WY", "baseline_rate": 1.8906, "hist_rate_1933_42": 4.8803}], "national_mean_nonmig_rate": 3.4246, "G_hist_geomean_migrants": 4.0149, "beta_m": 0.23, "calibration_k": 1.0178854263318513, "metadata": {"observed_migrant_deaths_2000_17": 26893.0}};

const selectRes = document.getElementById('select-res');
const selectBirth = document.getElementById('select-birth');
const lblRes = document.getElementById('lbl-res');
const lblBirth = document.getElementById('lbl-birth');
const summary = document.getElementById('summary');
const context = document.getElementById('context');
const barBase = document.getElementById('bar-base');
const barPred = document.getElementById('bar-pred');
const valBase = document.getElementById('val-base');
const valPred = document.getElementById('val-pred');
const originSlider = document.getElementById('origin-slider');
const sliderOut = document.getElementById('slider-out');

const byState = new Map(DATA.states.map(s => [s.state, s]));
const codes = DATA.states.map(s => s.state).sort();

for (const code of codes) {
  for (const sel of [selectRes, selectBirth]) {
    const opt = document.createElement('option');
    opt.value = code; opt.textContent = code;
    sel.appendChild(opt);
  }
}

const x0 = 140, xMax = 660;
const fullWidth = xMax - x0;

function fmt(n) { return (n ?? 0).toFixed(2); }
function pctDelta(from, to) { if (!from || !isFinite(from)) return 0; return ((to - from)/from)*100; }

function messageForHist(stateCode) {
  const s = byState.get(stateCode);
  if (!s) return '';
  const histVals = DATA.states.map(s => s.hist_rate_1933_42).slice().sort((a,b)=>a-b);
  const T1 = histVals[Math.floor(histVals.length/3)];
  const T2 = histVals[Math.floor(2*histVals.length/3)];
  const h = s.hist_rate_1933_42;
  if (h <= T1) return 'In the 1930s, ' + stateCode + ' was among the safer states. That legacy still shapes risk today.';
  if (h >= T2) return 'In the 1930s, ' + stateCode + ' had one of the highest homicide rates. That legacy still shapes risk today.';
  return 'In the 1930s, ' + stateCode + ' was around the national middle on homicide. That legacy still shapes risk today.';
}

function mkScale(maxVal) {
  const domainMax = Math.max(1, maxVal) * 1.10;
  return v => x0 + Math.max(0, Math.min(v, domainMax)) / domainMax * fullWidth;
}

function renderBaseline(res) {
  const r = byState.get(res);
  lblRes.textContent = res || '—';
  if (!r) return;
  const baseline = r.baseline_rate;
  const scaleX = mkScale(baseline);
  const baseWidth = scaleX(baseline) - x0;
  barBase.style.transition = 'width 250ms ease';
  barBase.setAttribute('width', baseWidth);
  valBase.setAttribute('x', x0 + baseWidth + 6);
  valBase.textContent = fmt(baseline);
  summary.innerHTML = 'Locals in <strong>' + res + '</strong> face a homicide risk of <strong>' + fmt(baseline) + '</strong> per 100,000.';
}

function predictFrom(res, birth) {
  const r = byState.get(res), b = byState.get(birth);
  if (!r || !b) return null;
  const baseline = r.baseline_rate;
  const G = DATA.G_hist_geomean_migrants, beta = DATA.beta_m, k = DATA.calibration_k;
  const factor = k * Math.pow(b.hist_rate_1933_42 / G, beta);
  return baseline * factor;
}

function update() {
  const res = selectRes.value;
  const birth = selectBirth.value;
  const r = byState.get(res);
  const b = byState.get(birth);

  if (!r) {
    barBase.setAttribute('width','0'); barPred.setAttribute('width','0');
    valBase.textContent = '—'; valPred.textContent = '—';
    lblRes.textContent = '—'; lblBirth.textContent = '—';
    summary.textContent = 'Pick your states to view your estimated risk.';
    context.textContent = '';
    sliderOut.textContent = 'Choose a residence first to see the effect.';
    return;
  }

  renderBaseline(res);

  if (!b) {
    lblBirth.textContent = '—';
    barPred.setAttribute('width','0'); valPred.textContent = '—';
    context.textContent = '';
    return;
  }

  lblBirth.textContent = birth;
  const baseline = r.baseline_rate;
  const predicted = predictFrom(res, birth);
  const scaleX = mkScale(Math.max(baseline, predicted));
  const predWidth = scaleX(predicted) - x0;
  const baseWidth = scaleX(baseline) - x0;

  barBase.style.transition = 'width 250ms ease'; barPred.style.transition = 'width 250ms ease';
  barBase.setAttribute('width', baseWidth);
  barPred.setAttribute('width', predWidth);
  valBase.setAttribute('x', x0 + baseWidth + 6); valBase.textContent = fmt(baseline);
  valPred.setAttribute('x', x0 + predWidth + 6); valPred.textContent = fmt(predicted);

  const pct = pctDelta(baseline, predicted);
  const times = (predicted / baseline);
  const moreLess = pct >= 0 ? 'higher' : 'lower';
  summary.innerHTML = 'Migrants from <strong>' + birth + '</strong> in <strong>' + res + '</strong> face <strong>' + times.toFixed(2) + '×</strong> (' + pct.toFixed(1) + '%) ' + moreLess + ' homicide risk than locals in ' + res + '.';

  context.textContent = messageForHist(birth);
}

// Slider logic (independent panel)
const minHist = Math.min(...DATA.states.map(s => s.hist_rate_1933_42));
const maxHist = Math.max(...DATA.states.map(s => s.hist_rate_1933_42));

originSlider.addEventListener('input', () => {
  const res = selectRes.value;
  if (!res) { sliderOut.textContent = 'Choose a residence first to see the effect.'; return; }
  const r = byState.get(res);
  const baseline = r.baseline_rate;
  const t = originSlider.value / 100;
  const h = minHist + t*(maxHist - minHist);
  const G = DATA.G_hist_geomean_migrants, beta = DATA.beta_m, k = DATA.calibration_k;
  const low = baseline * (k * Math.pow(minHist/G, beta));
  const high = baseline * (k * Math.pow(maxHist/G, beta));
  const predicted = baseline * (k * Math.pow(h/G, beta));
  const pct = pctDelta(baseline, predicted);
  const moreLess = pct >= 0 ? 'higher' : 'lower';
  sliderOut.textContent = 'If your birth state ranged from the safest to the most violent, your risk would vary from ' + fmt(low) + ' to ' + fmt(high) + ' per 100,000 (currently: ' + fmt(predicted) + '; ' + pct.toFixed(1) + '% ' + moreLess + ' than locals).';
});

selectRes.addEventListener('change', update);
selectBirth.addEventListener('change', update);
</script>
</body>
</html>
